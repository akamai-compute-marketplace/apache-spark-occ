- name: Configuring environment
  hosts: localhost
  connection: local
  vars_files:
    - group_vars/spark/vars
    - group_vars/spark/secret_vars

  vars:
    count: 2

  tasks:
    - name: creating Spark servers
      linode.cloud.instance:
        label: '{{ instance_prefix }}{{ item | int + 1 }}-{{ uuid }}'
        api_token: '{{ token }}'
        type: '{{ type }}'
        region: '{{ region }}'
        image: '{{ image }}'
        root_pass: '{{ root_pass }}'
        authorized_keys: '{{ ssh_keys }}'
        private_ip: true
        stackscript_id: 1146322
        ua_prefix: 'marketplace-spark-occ'
        tags: '{{ linode_tags }}'
        state: present
      register: linode
      with_sequence: count='{{ count }}'

    - name: Get info about an instance by label
      linode.cloud.instance_info:
        api_token: '{{ token }}'
        label: '{{ instance_prefix }}{{ item | int + 1 }}-{{ uuid }}'
      register: info
      with_sequence: count='{{ count }}'

    - name: set facts
      set_fact:
        spark_master_hostname: '{{ instance_prefix }}1.{{ cluster_name }}'
        spark_worker1_hostname: '{{ info.results[0].instance.label }}.{{ cluster_name }}'
        spark_worker2_hostname: '{{ info.results[1].instance.label }}.{{ cluster_name }}'
        # public ips
        spark_master_ip1: '{{ ansible_all_ipv4_addresses[0] }}'
        spark_worker1_ip1: '{{ info.results[0].instance.ipv4[0] }}'
        spark_worker2_ip1: '{{ info.results[1].instance.ipv4[0] }}'
        # private ips
        spark_master_priv1: '{{ ansible_all_ipv4_addresses[1] }}'
        spark_worker1_priv1: '{{ info.results[0].instance.ipv4[1] }}'
        spark_worker2_priv1: '{{ info.results[1].instance.ipv4[1] }}'

    - name: update group_vars
      blockinfile:
        path: ./group_vars/spark/vars
        marker: "# {mark} INSTANCE VARS"
        block: |
          # hostnames
          spark_master_hostname: {{ spark_master_hostname | replace('_', '-') }}
          spark_worker1_hostname: {{ spark_worker1_hostname | replace('_', '-') }}
          spark_worker2_hostname: {{ spark_worker2_hostname | replace('_', '-')}}
          # public ips
          spark_master_ip1: {{ spark_master_ip1 }}
          spark_worker1_ip1: {{ spark_worker1_ip1 }}
          spark_worker2_ip1: {{ spark_worker2_ip1 }}
          # private ips
          spark_master_priv1: {{ spark_master_priv1 }}
          spark_worker1_priv1: {{ spark_worker1_priv1 }}
          spark_worker2_priv1: {{ spark_worker2_priv1 }}

    - name: test connectivity
      ping:
      with_items: "{{ info.results }}"

    - name: update inventory
      blockinfile:
        path: ./hosts
        marker: "# {mark} SPARK NODES"
        block: |
          [spark_master]
          localhost ansible_connection=local user=root
          [spark_workers]
          {{ spark_worker1_ip1 }}
          {{ spark_worker2_ip1 }}

    - name: wait for port 22 to become open
      wait_for:
        port: 22
        host: '{{ item }}'
        search_regex: OpenSSH
        delay: 10
      connection: local
      with_items:
        - '{{ spark_master_ip1 }}'
        - '{{ spark_worker1_ip1 }}'
        - '{{ spark_worker2_ip1 }}'
