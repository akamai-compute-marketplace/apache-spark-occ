# roles/post/tasks/sshkeys.yml

- name: set root password on remote nodes
  lineinfile:
    path: /etc/shadow
    regexp: '^root.+'
    line: '{{ root_password }}'

- name: set ssh facts
  set_fact:
    add_keys_prompt: '{{ add_keys_prompt }}'

- name: Extract the first line of /root/.ssh/authorized_keys
  command: "head -n 1 /root/.ssh/authorized_keys"
  register: first_line_key
  when: "'spark_master' in group_names"

# - name: Append first line of master authorized_keys to workers
#   lineinfile:
#     path: "{{ item }}/.ssh/authorized_keys"
#     line: "{{ first_line_key.stdout }}"
#     create: yes
#     state: present
#   with_items: "{{ groups['spark_workers'] }}"
#   when: "'spark_master' in group_names"

- name: Append master's key to workers' authorized_keys
  lineinfile:
    path: "/root/.ssh/authorized_keys"
    line: "{{ hostvars[groups['spark_master'][0]]['first_line_key']['stdout'] }}"
    state: present
  when: "'spark_workers' in group_names"

- name: remove ansible from authorized_keys
  lineinfile:
    dest: /root/.ssh/authorized_keys
    state: absent
    regexp: '^.+ansible$'

- name: remove ansible ssh keys
  file:
    path: '{{ item }}'
    state: absent
  run_once: true
  delegate_to: localhost
  loop:
    - '{{ ansible_env.HOME }}/.ssh/id_ansible_ed25519'
    - '{{ ansible_env.HOME }}/.ssh/id_ansible_ed25519.pub'